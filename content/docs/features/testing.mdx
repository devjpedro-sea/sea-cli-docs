---
title: Testing com Jest
description: Configuração completa de testes unitários e integração com Jest
---

# Testing com Jest

Framework de testes completo configurado automaticamente pelo SEA CLI, incluindo Jest, Testing Library, cobertura de código e integração com CI/CD.

## Visão Geral

O SEA CLI configura:

- **Jest**: Framework de testes JavaScript
- **Testing Library**: Testes de componentes React
- **Coverage**: Relatórios de cobertura
- **Mocks**: Mocks do Liferay e APIs
- **CI/CD**: Integração com pipelines

## Configuração Gerada

### jest.config.js

```javascript
module.exports = {
  testEnvironment: 'jsdom',
  
  roots: ['<rootDir>/modules', '<rootDir>/client-extensions'],
  
  testMatch: [
    '**/__tests__/**/*.{js,jsx,ts,tsx}',
    '**/*.{spec,test}.{js,jsx,ts,tsx}'
  ],
  
  moduleNameMapper: {
    '\\.(css|less|scss|sass)$': 'identity-obj-proxy',
    '\\.(jpg|jpeg|png|gif|svg)$': '<rootDir>/__mocks__/fileMock.js',
    '^@/(.*)$': '<rootDir>/$1'
  },
  
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  
  collectCoverageFrom: [
    '**/*.{js,jsx,ts,tsx}',
    '!**/*.config.js',
    '!**/node_modules/**',
    '!**/coverage/**',
    '!**/build/**',
    '!**/dist/**'
  ],
  
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70
    }
  },
  
  transform: {
    '^.+\\.(js|jsx|ts|tsx)$': 'babel-jest'
  },
  
  moduleFileExtensions: ['js', 'jsx', 'ts', 'tsx', 'json', 'node']
};
```

### jest.setup.js

```javascript
import '@testing-library/jest-dom';

// Mock Liferay global
global.Liferay = {
  authToken: 'mock-token',
  ThemeDisplay: {
    getCompanyId: () => '20116',
    getUserId: () => '20123',
    getScopeGroupId: () => '20124',
    getLanguageId: () => 'pt_BR',
    getPathThemeImages: () => '/o/theme/images',
    isSignedIn: () => true
  },
  Language: {
    get: (key) => key
  },
  Util: {
    openWindow: jest.fn()
  }
};

// Mock window.location
delete window.location;
window.location = {
  href: 'http://localhost',
  pathname: '/',
  search: '',
  hash: ''
};

// Suppress console warnings em testes
global.console = {
  ...console,
  warn: jest.fn(),
  error: jest.fn()
};
```

### babel.config.js

```javascript
module.exports = {
  presets: [
    ['@babel/preset-env', { targets: { node: 'current' } }],
    '@babel/preset-react',
    '@babel/preset-typescript'
  ],
  plugins: [
    '@babel/plugin-transform-runtime'
  ]
};
```

## Estrutura de Testes

### Organização

```
modules/produto-portlet/
├── src/
│   ├── components/
│   │   ├── ProductList.jsx
│   │   └── ProductItem.jsx
│   └── utils/
│       └── api.js
└── __tests__/
    ├── components/
    │   ├── ProductList.test.js
    │   └── ProductItem.test.js
    └── utils/
        └── api.test.js
```

Ou co-localizado:

```
modules/produto-portlet/
└── src/
    ├── components/
    │   ├── ProductList.jsx
    │   ├── ProductList.test.js
    │   ├── ProductItem.jsx
    │   └── ProductItem.test.js
    └── utils/
        ├── api.js
        └── api.test.js
```

## Exemplos de Testes

### Teste de Componente

```javascript
// src/components/ProductList.test.js
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import ProductList from './ProductList';

describe('ProductList', () => {
  const mockProducts = [
    { id: 1, name: 'Produto 1', price: 100 },
    { id: 2, name: 'Produto 2', price: 200 }
  ];
  
  it('deve renderizar lista de produtos', () => {
    render(<ProductList products={mockProducts} />);
    
    expect(screen.getByText('Produto 1')).toBeInTheDocument();
    expect(screen.getByText('Produto 2')).toBeInTheDocument();
  });
  
  it('deve exibir mensagem quando vazio', () => {
    render(<ProductList products={[]} />);
    
    expect(screen.getByText(/nenhum produto/i)).toBeInTheDocument();
  });
  
  it('deve filtrar produtos por nome', async () => {
    const user = userEvent.setup();
    render(<ProductList products={mockProducts} />);
    
    const searchInput = screen.getByPlaceholderText(/buscar/i);
    await user.type(searchInput, 'Produto 1');
    
    expect(screen.getByText('Produto 1')).toBeInTheDocument();
    expect(screen.queryByText('Produto 2')).not.toBeInTheDocument();
  });
  
  it('deve chamar onSelect ao clicar em produto', async () => {
    const user = userEvent.setup();
    const handleSelect = jest.fn();
    
    render(<ProductList products={mockProducts} onSelect={handleSelect} />);
    
    await user.click(screen.getByText('Produto 1'));
    
    expect(handleSelect).toHaveBeenCalledWith(mockProducts[0]);
  });
});
```

### Teste com Async

```javascript
// src/components/ProductLoader.test.js
import { render, screen, waitFor } from '@testing-library/react';
import ProductLoader from './ProductLoader';
import * as api from '../utils/api';

jest.mock('../utils/api');

describe('ProductLoader', () => {
  it('deve exibir loading inicial', () => {
    api.fetchProducts.mockImplementation(() => new Promise(() => {}));
    
    render(<ProductLoader />);
    
    expect(screen.getByText(/carregando/i)).toBeInTheDocument();
  });
  
  it('deve carregar e exibir produtos', async () => {
    const mockProducts = [
      { id: 1, name: 'Produto 1' }
    ];
    
    api.fetchProducts.mockResolvedValue(mockProducts);
    
    render(<ProductLoader />);
    
    await waitFor(() => {
      expect(screen.getByText('Produto 1')).toBeInTheDocument();
    });
  });
  
  it('deve exibir erro ao falhar', async () => {
    api.fetchProducts.mockRejectedValue(new Error('API Error'));
    
    render(<ProductLoader />);
    
    await waitFor(() => {
      expect(screen.getByText(/erro ao carregar/i)).toBeInTheDocument();
    });
  });
});
```

### Teste de Função

```javascript
// src/utils/format.test.js
import { formatPrice, formatDate } from './format';

describe('format', () => {
  describe('formatPrice', () => {
    it('deve formatar preço em BRL', () => {
      expect(formatPrice(100)).toBe('R$ 100,00');
      expect(formatPrice(1234.56)).toBe('R$ 1.234,56');
    });
    
    it('deve tratar valores inválidos', () => {
      expect(formatPrice(null)).toBe('R$ 0,00');
      expect(formatPrice(undefined)).toBe('R$ 0,00');
      expect(formatPrice('abc')).toBe('R$ 0,00');
    });
  });
  
  describe('formatDate', () => {
    it('deve formatar data', () => {
      const date = new Date('2024-01-15');
      expect(formatDate(date)).toBe('15/01/2024');
    });
    
    it('deve aceitar string', () => {
      expect(formatDate('2024-01-15')).toBe('15/01/2024');
    });
  });
});
```

### Teste com API Mock

```javascript
// src/utils/api.test.js
import { fetchProducts, createProduct } from './api';

// Mock fetch global
global.fetch = jest.fn();

describe('API', () => {
  beforeEach(() => {
    fetch.mockClear();
  });
  
  describe('fetchProducts', () => {
    it('deve buscar produtos', async () => {
      const mockData = { items: [{ id: 1, name: 'Produto 1' }] };
      
      fetch.mockResolvedValue({
        ok: true,
        json: async () => mockData
      });
      
      const result = await fetchProducts();
      
      expect(fetch).toHaveBeenCalledWith(
        '/o/headless-delivery/v1.0/products',
        expect.objectContaining({
          headers: expect.objectContaining({
            'Authorization': 'Bearer mock-token'
          })
        })
      );
      
      expect(result).toEqual(mockData.items);
    });
    
    it('deve tratar erro de rede', async () => {
      fetch.mockRejectedValue(new Error('Network error'));
      
      await expect(fetchProducts()).rejects.toThrow('Network error');
    });
    
    it('deve tratar erro HTTP', async () => {
      fetch.mockResolvedValue({
        ok: false,
        status: 404,
        statusText: 'Not Found'
      });
      
      await expect(fetchProducts()).rejects.toThrow('Not Found');
    });
  });
  
  describe('createProduct', () => {
    it('deve criar produto', async () => {
      const newProduct = { name: 'Novo Produto', price: 100 };
      const mockResponse = { id: 1, ...newProduct };
      
      fetch.mockResolvedValue({
        ok: true,
        json: async () => mockResponse
      });
      
      const result = await createProduct(newProduct);
      
      expect(fetch).toHaveBeenCalledWith(
        '/o/headless-delivery/v1.0/products',
        expect.objectContaining({
          method: 'POST',
          body: JSON.stringify(newProduct)
        })
      );
      
      expect(result).toEqual(mockResponse);
    });
  });
});
```

## Mocks

### Mock de Módulos

```javascript
// src/components/Product.test.js
import { render } from '@testing-library/react';
import Product from './Product';

// Mock módulo inteiro
jest.mock('../utils/api', () => ({
  fetchProduct: jest.fn().mockResolvedValue({ id: 1, name: 'Produto' })
}));

// Mock parcial
jest.mock('../utils/api', () => ({
  ...jest.requireActual('../utils/api'),
  fetchProduct: jest.fn()
}));
```

### Mock de Componentes

```javascript
// Mock componente complexo
jest.mock('./ComplexComponent', () => {
  return function MockComplex({ title }) {
    return <div data-testid="complex">{title}</div>;
  };
});
```

### Mock de Imagens/CSS

```javascript
// __mocks__/fileMock.js
module.exports = 'test-file-stub';
```

```javascript
// jest.config.js
moduleNameMapper: {
  '\\.(css|less|scss)$': 'identity-obj-proxy',
  '\\.(jpg|png|svg)$': '<rootDir>/__mocks__/fileMock.js'
}
```

### Mock do Liferay

```javascript
// __mocks__/liferay.js
export const mockLiferay = {
  authToken: 'test-token',
  ThemeDisplay: {
    getCompanyId: jest.fn(() => '20116'),
    getUserId: jest.fn(() => '20123'),
    getScopeGroupId: jest.fn(() => '20124'),
    getLanguageId: jest.fn(() => 'pt_BR')
  },
  Language: {
    get: jest.fn((key) => key)
  }
};

global.Liferay = mockLiferay;
```

## Cobertura de Código

### Executar com Coverage

```bash
# Gerar relatório de cobertura
npm run test:coverage

# Output:
# ----------------------------|---------|----------|---------|---------|
# File                        | % Stmts | % Branch | % Funcs | % Lines |
# ----------------------------|---------|----------|---------|---------|
# All files                   |   85.23 |    78.45 |   82.11 |   85.67 |
#  components                 |   90.12 |    85.23 |   88.45 |   90.34 |
#   ProductList.jsx           |   95.45 |    92.31 |   94.12 |   95.67 |
#   ProductItem.jsx           |   84.23 |    78.56 |   82.45 |   85.12 |
#  utils                      |   78.34 |    65.23 |   72.45 |   79.12 |
#   api.js                    |   82.12 |    70.45 |   78.23 |   83.45 |
# ----------------------------|---------|----------|---------|---------|
```

### Relatório HTML

```bash
npm run test:coverage

# Abrir relatório
open coverage/lcov-report/index.html
```

### Threshold

```javascript
// jest.config.js
coverageThreshold: {
  global: {
    branches: 80,
    functions: 80,
    lines: 80,
    statements: 80
  },
  
  // Por arquivo
  './src/utils/api.js': {
    branches: 90,
    functions: 90,
    lines: 90,
    statements: 90
  }
}
```

Se coverage ficar abaixo, build falha:

```bash
npm test

# Jest: "global" coverage threshold for statements (75%) not met: 70%
# npm ERR! Test failed.
```

## Scripts NPM

### package.json

```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --maxWorkers=2",
    "test:changed": "jest --onlyChanged",
    "test:related": "jest --findRelatedTests",
    "test:debug": "node --inspect-brk node_modules/.bin/jest --runInBand",
    "test:update": "jest --updateSnapshot"
  }
}
```

### Comandos

```bash
# Executar todos os testes
npm test

# Watch mode (reexecuta ao modificar)
npm run test:watch

# Coverage
npm run test:coverage

# Apenas testes modificados
npm run test:changed

# Testes relacionados a arquivo
npm run test:related src/App.js

# CI (sem watch, paralelo)
npm run test:ci

# Debug
npm run test:debug

# Atualizar snapshots
npm run test:update
```

## Snapshots

### Criar Snapshot

```javascript
// src/components/Product.test.js
import { render } from '@testing-library/react';
import Product from './Product';

it('deve corresponder ao snapshot', () => {
  const { container } = render(
    <Product name="Produto" price={100} />
  );
  
  expect(container).toMatchSnapshot();
});
```

### Snapshot Gerado

```javascript
// __snapshots__/Product.test.js.snap
exports[`deve corresponder ao snapshot 1`] = `
<div>
  <div class="product">
    <h3>Produto</h3>
    <p>R$ 100,00</p>
  </div>
</div>
`;
```

### Atualizar Snapshots

```bash
# Atualizar todos
npm run test:update

# Atualizar interativamente
npm test -- --updateSnapshot
```

## Teste JSP

### Extrair JavaScript

```html
<!-- src/main/resources/META-INF/resources/view.jsp -->
<%@ page contentType="text/html; charset=UTF-8" %>

<div id="product-list"></div>

<script src="product-list.js"></script>
```

```javascript
// src/main/resources/META-INF/resources/product-list.js
function renderProducts(products) {
  const container = document.getElementById('product-list');
  
  container.innerHTML = products
    .map(p => `<div class="product">${p.name}</div>`)
    .join('');
}

// Exportar para teste
if (typeof module !== 'undefined') {
  module.exports = { renderProducts };
}
```

```javascript
// __tests__/product-list.test.js
const { renderProducts } = require('../src/main/resources/META-INF/resources/product-list');

describe('renderProducts', () => {
  beforeEach(() => {
    document.body.innerHTML = '<div id="product-list"></div>';
  });
  
  it('deve renderizar produtos', () => {
    const products = [
      { id: 1, name: 'Produto 1' },
      { id: 2, name: 'Produto 2' }
    ];
    
    renderProducts(products);
    
    const container = document.getElementById('product-list');
    expect(container.children).toHaveLength(2);
    expect(container.textContent).toContain('Produto 1');
  });
});
```

## Watch Mode

### Executar

```bash
npm run test:watch
```

### Comandos Interativos

```
Watch Usage
 › Press a to run all tests.
 › Press f to run only failed tests.
 › Press p to filter by a filename regex pattern.
 › Press t to filter by a test name regex pattern.
 › Press q to quit watch mode.
 › Press Enter to trigger a test run.
```

### Filtros

```bash
# Pattern de arquivo
# Digite: p
# Pattern: product
# Executa: ProductList.test.js, ProductItem.test.js

# Pattern de teste
# Digite: t
# Pattern: deve renderizar
# Executa apenas testes com "deve renderizar" no nome
```

## Troubleshooting

### Erro: Cannot find module

**Problema:**
```
Cannot find module 'react' from 'src/App.jsx'
```

**Solução:**
```bash
npm install --save-dev react react-dom
```

### Erro: Unexpected token

**Problema:**
```
SyntaxError: Unexpected token '<'
```

**Solução:**
```javascript
// babel.config.js
module.exports = {
  presets: [
    '@babel/preset-env',
    '@babel/preset-react'  // Adicionar preset React
  ]
};
```

### Testes lentos

**Problema:**
Testes demoram muito

**Solução:**
```javascript
// jest.config.js
module.exports = {
  maxWorkers: '50%',  // Usar 50% dos cores
  
  // Cache
  cache: true,
  cacheDirectory: '<rootDir>/.jest-cache'
};
```

```bash
# Executar em paralelo
npm test -- --maxWorkers=4
```

### Mock não funciona

**Problema:**
Mock não é aplicado

**Solução:**
```javascript
// Limpar mocks entre testes
beforeEach(() => {
  jest.clearAllMocks();
});

// Ou resetar tudo
beforeEach(() => {
  jest.resetAllMocks();
});
```

## CI/CD

### GitHub Actions

```yaml
name: Tests
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - run: npm ci
      
      - name: Run tests
        run: npm run test:ci
        
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
```

### GitLab CI

```yaml
test:
  stage: test
  script:
    - npm ci
    - npm run test:ci
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
```

## Boas Práticas

<Callout type="tip">
### Recomendações
- **Testes co-localizados**: Próximos ao código que testam
- **Nomes descritivos**: Use "deve..." para clareza
- **AAA Pattern**: Arrange, Act, Assert
- **Um assert por teste**: Foco em uma coisa
- **Mocks mínimos**: Mock apenas o necessário
- **Coverage > 80%**: Meta de cobertura alta
- **TDD**: Escreva testes antes do código
</Callout>

## Recursos Relacionados

- [Jest Docs](https://jestjs.io/)
- [Testing Library](https://testing-library.com/)
- [ESLint + Prettier](/docs/features/eslint-prettier)
- [CI/CD](/docs/workflows/ci-cd)

---

**Testes automatizados garantem qualidade!** Jest + Testing Library configurados e prontos.
